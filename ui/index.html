<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Workspace</title>
    <style>
        :root { 
            --primary: #2d3436; 
            --accent: #0011ca; 
            --bg: #f8f9fa; 
            --bot-bubble: #ffffff;\n            --user-bubble: #0984e3;
            --sidebar-bg: #1e1e2e;
        }

        body { 
            font-family: 'Segoe UI', -apple-system, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: var(--bg); 
            display: flex; 
            flex-direction: row; 
            height: 100vh; 
            overflow: hidden; 
        }

        #sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            color: white;
            height: 100vh;
            transition: transform 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            transform: translateX(-100%);
        }

        #sidebar.visible {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .sidebar-toggle-tab {
            position: fixed;
            left: 0;
            top: 20px;
            background: var(--sidebar-bg);
            color: white;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 1001;
            transition: left 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        #sidebar.visible ~ .sidebar-toggle-tab {
            left: 300px;
        }

        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            transition: margin-left 0.3s ease;
        }

        #sidebar.visible + #main-content {
            margin-left: 300px;
        }

        .header { 
            background: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            z-index: 10;
        }
        .logo { font-weight: 800; font-size: 1.1rem; color: var(--primary); }

        #chat-history { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .user-wrapper { align-self: flex-end; align-items: flex-end; }
        .bot-wrapper { align-self: flex-start; align-items: flex-start; }

        .message { padding: 12px 18px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .user { background: var(--user-bubble); color: white; border-bottom-right-radius: 2px; }
        .bot { background: var(--bot-bubble); color: #333; border-bottom-left-radius: 2px; border: 1px solid #eee; }

        .config-section { margin-bottom: 20px; }
        .config-label { display: block; font-size: 12px; margin-bottom: 5px; color: #aaa; }
        .config-input { 
            width: 100%; 
            padding: 8px; 
            background: #2a2a3e; 
            border: 1px solid #444; 
            color: white; 
            border-radius: 4px; 
            font-size: 13px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .btn-save {
            width: 100%;
            padding: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        #drop-zone {
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #drop-zone.active { border-color: var(--accent); color: var(--accent); background: #2a2a3e; }

        .input-container { padding: 10px 20px 20px; }
        .input-box { 
            background: white; border-radius: 30px; display: flex; align-items: center; 
            padding: 2px 10px; border: 1px solid #eee;
        }
        #user-input { flex-grow: 1; border: none; padding: 10px 15px; outline: none; font-size: 14px; background: transparent; }
        .send-btn { background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px; }

        #file-list { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
        .file-tag { background: #dfe6e9; padding: 2px 6px; border-radius: 8px; font-size: 10px; color: #2d3436; }
    </style>
</head>
<body>

    <div id=\"sidebar\">
        <div class=\"sidebar-header\">
            <h3 style=\"margin:0\">Settings</h3>
            <span onclick=\"toggleSidebar()\" style=\"cursor:pointer\">×</span>
        </div>
        
        <div class=\"config-section\">
            <label class=\"config-label\">Provider</label>\n            <select id=\"provider-select\" class=\"config-input\" onchange=\"updateProvider()\">
                <option value=\"openai\">OpenAI</option>
                <option value=\"anthropic\">Anthropic</option>
                <option value=\"gemini\">Gemini</option>
                <option value=\"grok\">Grok (xAI)</option>
                <option value=\"groq\">Groq</option>
                <option value=\"openrouter\">OpenRouter</option>
                <option value=\"perplexity\">Perplexity</option>
            </select>

            <label class=\"config-label\">Model ID (Optional)</label>
            <input type=\"text\" id=\"model-input\" class=\"config-input\" placeholder=\"e.g. gpt-4o\" onchange=\"updateModel()\">

            <label class=\"config-label\">API Key</label>
            <input type=\"password\" id=\"api-key\" class=\"config-input\" placeholder=\"sk-...\">
            
            <button class=\"btn-save\" onclick=\"saveKey()\">Save Configuration</button>
        </div>

        <hr style=\"border: 0; border-top: 1px solid #444; margin: 20px 0;\">

        <h4 style=\"margin:0 0 10px 0; font-size:14px\">Knowledge Base</h4>
        <div id=\"drop-zone\" onclick=\"document.getElementById('file-input').click()\">
            Drag PDF/CSV here<br>or Click to upload
        </div>
        <input type=\"file\" id=\"file-input\" multiple style=\"display:none\" onchange=\"handleFileSelect(event)\">
        <div id=\"sidebar-file-list\" style=\"margin-top:10px\"></div>
        
        <button onclick=\"clearRag()\" style=\"width:100%; margin-top:15px; background:#c0392b; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; font-size:12px\">Clear Context</button>
    </div>

    <div class=\"sidebar-toggle-tab\" onclick=\"toggleSidebar()\" id=\"key-tab\">
        <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">
            <path d=\"M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4\"></path>
        </svg>
    </div>

    <div id=\"main-content\">
        <div class=\"header\">
            <div class=\"logo\">Agentic Workspace</div>
            <div style=\"font-size: 11px; color: #666;\">
                Multi-Agent: <input type=\"checkbox\" id=\"agent-toggle\" onchange=\"toggleAgents()\">
            </div>
        </div>

        <div id=\"chat-history\"></div>

        <div class=\"input-container\">
            <div id=\"file-list\"></div>
            <div class=\"input-box\">
                <input type=\"text\" id=\"user-input\" placeholder=\"Ask your agent...\" onkeypress=\"handleEnter(event)\">
                <button class=\"send-btn\" onclick=\"sendPrompt()\">↑</button>
            </div>
        </div>
    </div>

    <script src=\"anime.min.js\"></script>
    <script src=\"marked.min.js\"></script>
    
    <script>
        let currentBotMsgId = null;
        let botBuffers = {};

        window.addEventListener('pywebviewready', async () => {
            const history = await window.pywebview.api.load_history();
            history.forEach(msg => appendMessage(msg.role, msg.content, false));
            setupDragAndDrop();
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('visible');
        }

        async function toggleAgents() {
            const enabled = document.getElementById('agent-toggle').checked;
            await window.pywebview.api.toggle_multi_agent(enabled);
        }

        async function updateProvider() {
            const p = document.getElementById('provider-select').value;
            await window.pywebview.api.set_provider(p);
        }

        async function updateModel() {
            const m = document.getElementById('model-input').value;
            await window.pywebview.api.set_model(m);
        }

        async function saveKey() {
            const k = document.getElementById('api-key').value;
            const p = document.getElementById('provider-select').value;
            if(!k) { alert(\"Please enter a key\"); return; }
            const res = await window.pywebview.api.set_api_key(k, p);
            alert(res);
        }

        async function clearRag() {
            const res = await window.pywebview.api.clear_rag_context();
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('sidebar-file-list').innerHTML = '';
            alert(res);
        }

        function setupDragAndDrop() {
            const dz = document.getElementById('drop-zone');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
            });
            dz.addEventListener('dragover', () => dz.classList.add('active'));
            dz.addEventListener('dragleave', () => dz.classList.remove('active'));
            dz.addEventListener('drop', e => processFiles(e.dataTransfer.files));
        }

        function handleFileSelect(e) { processFiles(e.target.files); }

        async function processFiles(filesList) {
            const dz = document.getElementById('drop-zone');
            dz.classList.remove('active');
            const files = Array.from(filesList);
            const uploadData = [];
            for (const file of files) {
                const reader = new FileReader();
                const promise = new Promise(resolve => {
                    reader.onload = e => resolve({ name: file.name, content: e.target.result });
                    reader.readAsDataURL(file);
                });
                uploadData.push(await promise);
            }
            if (uploadData.length > 0) {
                dz.innerText = \"Ingesting...\";
                const res = await window.pywebview.api.upload_files(uploadData);
                if (res.status === 'success') {
                    updateFileList(res.files);
                    dz.innerText = \"Files ready!\";
                    setTimeout(() => { dz.innerText = \"Drag PDF/CSV here\\nor Click to upload\"; }, 3000);
                } else {
                    alert(\"Error: \" + res.message);
                    dz.innerText = \"Drag PDF/CSV here\\nor Click to upload\";
                }
            }
        }

        function updateFileList(files) {
            const list = document.getElementById('file-list');
            const sidebarList = document.getElementById('sidebar-file-list');
            const html = files.map(f => `<div class=\"file-tag\">${f}</div>`).join('');
            list.innerHTML = html;\n            sidebarList.innerHTML = html;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendPrompt(); }

        function sendPrompt() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if(!val) return;
            input.value = '';
            appendMessage('user', val);
            const botId = 'bot-' + Date.now();
            currentBotMsgId = botId;
            botBuffers[botId] = \"\";
            createBotBubble(botId);
            window.pywebview.api.start_chat_stream(val);
        }

        function receiveChunk(chunk, targetId) {
            const id = targetId || currentBotMsgId;\n            const div = document.getElementById(id);
            if(div) {
                botBuffers[id] = (botBuffers[id] || \"\") + chunk;
                div.innerHTML = marked.parse(botBuffers[id]);
                scrollToBottom();
            }
        }

        function createBotBubble(id) {
            const container = document.getElementById('chat-history');
            const wrapper = document.createElement('div');
            wrapper.className = \"message-wrapper bot-wrapper\";
            wrapper.innerHTML = `<div class=\"message bot\" id=\"${id}\">...</div>`;
            container.appendChild(wrapper);
            scrollToBottom();
        }

        function clearBubble(id) {
            const div = document.getElementById(id);
            if(div) {
                div.innerHTML = \"\";
                botBuffers[id] = \"\"; // Important: Reset the buffer so new text doesn't append to old text
            }
        }

        function appendMessage(role, text, animate=true) {
            if(role === 'bot') {
                const id = 'bot-' + Math.random().toString(36).substr(2, 9);
                botBuffers[id] = text;
                createBotBubble(id);
                document.getElementById(id).innerHTML = marked.parse(text);
            } else {
                const container = document.getElementById('chat-history');
                const wrapper = document.createElement('div');
                wrapper.className = \"message-wrapper user-wrapper\";
                wrapper.innerHTML = `<div class=\"message user\">${text.replace(/</g, \"&lt;\")}</div>`;
                container.appendChild(wrapper);
            }
            scrollToBottom();
        }

        function scrollToBottom() { document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight; }
        function receiveError(e) { alert(\"Error: \" + e); }
        function streamComplete() { currentBotMsgId = null; }
    </script>
</body>
</html>