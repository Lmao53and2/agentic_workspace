<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Workspace</title>
    <style>
        :root { 
            --primary: #2d3436; 
            --accent: #0011ca; 
            --bg: #f8f9fa; 
            --bot-bubble: #ffffff;
            --user-bubble: #0984e3;
        }

        body { 
            font-family: 'Segoe UI', -apple-system, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: var(--bg); 
            display: flex; 
            flex-direction: row; 
            height: 100vh; 
            overflow: hidden; 
        }

        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            border-right: 1px solid #eee;
        }

        .header { 
            background: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            z-index: 10;
            flex-wrap: wrap;
            gap: 10px;
        }
        .logo { font-weight: 800; font-size: 1.1rem; color: var(--primary); }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        #chat-history { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .user-wrapper { align-self: flex-end; align-items: flex-end; }
        .bot-wrapper { align-self: flex-start; align-items: flex-start; }

        .message { padding: 12px 18px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .user { background: var(--user-bubble); color: white; border-bottom-right-radius: 2px; }
        .bot { background: var(--bot-bubble); color: #333; border-bottom-left-radius: 2px; border: 1px solid #eee; }

        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            color: #999;
            font-size: 11px;
            margin-bottom: 5px;
            transition: all 0.3s;
            cursor: pointer;
        }
        #drop-zone.active { border-color: var(--accent); color: var(--accent); background: #f0f3ff; }
        #file-list { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
        .file-tag { background: #dfe6e9; padding: 2px 6px; border-radius: 8px; font-size: 10px; color: #2d3436; }

        .input-container { padding: 10px 20px 20px; }
        .input-box { 
            background: white; border-radius: 30px; display: flex; align-items: center; 
            padding: 2px 10px; border: 1px solid #eee;
        }
        #user-input { flex-grow: 1; border: none; padding: 10px 15px; outline: none; font-size: 14px; background: transparent; }
        .send-btn { background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px; }

        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        select, input[type="text"], input[type="password"] {
            padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="main-content">
        <div class="header">
            <div class="logo">Agentic Workspace</div>
            <div class="controls">
                <div style="font-size: 11px;">
                    Multi-Agent: <label class="switch"><input type="checkbox" id="agent-toggle" onchange="toggleAgents()"><span class="slider"></span></label>
                </div>
                <select id="provider-select" onchange="changeProvider()">
                    <option value="perplexity">Perplexity</option>
                    <option value="openai">OpenAI</option>
                    <option value="groq">Groq</option>
                    <option value="openrouter">OpenRouter</option>
                </select>
                <input type="text" id="model-input" placeholder="Model (optional)" onchange="changeModel()">
                <input type="password" id="api-key" placeholder="API Key">
                <button onclick="saveKey()" style="font-size: 11px;">Save</button>
                <button onclick="clearRag()" style="font-size: 11px; background: #ff7675; color: white; border: none; padding: 5px 8px; border-radius: 4px;">Clear RAG</button>
            </div>
        </div>

        <div id="chat-history"></div>

        <div class="input-container">
            <div id="file-list"></div>
            <div id="drop-zone" onclick="document.getElementById('file-input').click()">Drag PDF/CSV here or Click to upload</div>
            <input type="file" id="file-input" multiple style="display:none" onchange="handleFileSelect(event)">
            <div class="input-box">
                <input type="text" id="user-input" placeholder="Ask your agent..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendPrompt()">â†‘</button>
            </div>
        </div>
    </div>

    <div id="checkpoint-sidebar"></div>

    <script src="anime.min.js"></script>
    <script src="marked.min.js"></script>
    
    <script>
        let currentBotMsgId = null;
        let botBuffers = {};

        window.addEventListener('pywebviewready', async () => {
            const history = await window.pywebview.api.load_history();
            history.forEach(msg => appendMessage(msg.role, msg.content, false));
            setupDragAndDrop();
        });

        async function toggleAgents() {
            const enabled = document.getElementById('agent-toggle').checked;
            await window.pywebview.api.toggle_multi_agent(enabled);
        }

        async function changeProvider() {
            const p = document.getElementById('provider-select').value;
            const res = await window.pywebview.api.set_provider(p);
            console.log(res);
        }

        async function changeModel() {
            const m = document.getElementById('model-input').value;
            await window.pywebview.api.set_model(m);
        }

        async function clearRag() {
            const res = await window.pywebview.api.clear_rag_context();
            document.getElementById('file-list').innerHTML = '';
            alert(res);
        }

        function setupDragAndDrop() {
            const dz = document.getElementById('drop-zone');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
            });
            dz.addEventListener('dragover', () => dz.classList.add('active'));
            dz.addEventListener('dragleave', () => dz.classList.remove('active'));
            dz.addEventListener('drop', e => processFiles(e.dataTransfer.files));
        }

        function handleFileSelect(e) { processFiles(e.target.files); }

        async function processFiles(filesList) {
            const dz = document.getElementById('drop-zone');
            dz.classList.remove('active');
            const files = Array.from(filesList);
            const uploadData = [];
            for (const file of files) {
                if (file.name.endsWith('.pdf') || file.name.endsWith('.csv')) {
                    const reader = new FileReader();
                    const promise = new Promise(resolve => {
                        reader.onload = e => resolve({ name: file.name, content: e.target.result });
                        reader.readAsDataURL(file);
                    });
                    uploadData.push(await promise);
                }
            }
            if (uploadData.length > 0) {
                dz.innerText = "Ingesting...";
                const res = await window.pywebview.api.upload_files(uploadData);
                if (res.status === 'success') {
                    updateFileList(res.files);
                    dz.innerText = "Files ready!";
                    setTimeout(() => { dz.innerText = "Drag PDF/CSV here or Click to upload"; }, 3000);
                } else {
                    alert("Error: " + res.message);
                    dz.innerText = "Drag PDF/CSV here or Click to upload";
                }
            }
        }

        function updateFileList(files) {
            const list = document.getElementById('file-list');
            list.innerHTML = files.map(f => `<div class="file-tag">${f}</div>`).join('');
        }

        async function saveKey() {
            const k = document.getElementById('api-key').value;
            const p = document.getElementById('provider-select').value;
            const res = await window.pywebview.api.set_api_key(k, p);
            alert(res);
        }

        function handleEnter(e) { if(e.key === 'Enter') sendPrompt(); }

        function sendPrompt() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if(!val) return;
            input.value = '';
            appendMessage('user', val);
            const botId = 'bot-' + Date.now();
            currentBotMsgId = botId;
            botBuffers[botId] = "";
            createBotBubble(botId);
            window.pywebview.api.start_chat_stream(val);
        }

        function receiveChunk(chunk, targetId) {
            const id = targetId || currentBotMsgId;
            const div = document.getElementById(id);
            if(div) {
                botBuffers[id] = (botBuffers[id] || "") + chunk;
                div.innerHTML = marked.parse(botBuffers[id]);
                scrollToBottom();
            }
        }

        function createBotBubble(id) {
            const container = document.getElementById('chat-history');
            const wrapper = document.createElement('div');
            wrapper.className = "message-wrapper bot-wrapper";
            wrapper.innerHTML = `<div class="message bot" id="${id}">...</div>`;
            container.appendChild(wrapper);
            scrollToBottom();
        }

        function appendMessage(role, text, animate=true) {
            if(role === 'bot') {
                const id = 'bot-' + Math.random().toString(36).substr(2, 9);
                botBuffers[id] = text;
                createBotBubble(id);
                document.getElementById(id).innerHTML = marked.parse(text);
            } else {
                const container = document.getElementById('chat-history');
                const wrapper = document.createElement('div');
                wrapper.className = "message-wrapper user-wrapper";
                wrapper.innerHTML = `<div class="message user">${text.replace(/</g, "&lt;")}</div>`;
                container.appendChild(wrapper);
            }
            scrollToBottom();
        }

        function scrollToBottom() { document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight; }

        function receiveError(e) { alert("Error: " + e); }
        function streamComplete() { currentBotMsgId = null; }
    </script>
</body>
</html>
